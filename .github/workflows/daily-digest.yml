name: Gmail ë©”ì¼ ì •ë¦¬

on:
  # ë§¤ì¼ ì˜¤ì „ 10ì‹œ KST = 01:00 UTC
  schedule:
    - cron: '0 1 * * *'

  # ìˆ˜ë™ ì‹¤í–‰ ë²„íŠ¼
  workflow_dispatch:
    inputs:
      mode:
        description: 'ì‹¤í–‰ ëª¨ë“œ'
        required: true
        default: 'today'
        type: choice
        options:
          - today        # ì˜¤ëŠ˜ 0ì‹œë¶€í„° í˜„ì¬ê¹Œì§€
          - last-24h     # 24ì‹œê°„ ì „ë¶€í„° í˜„ì¬ê¹Œì§€
          - custom       # íŠ¹ì • ë‚ ì§œ

      custom_date:
        description: 'íŠ¹ì • ë‚ ì§œ (YYYY-MM-DD, custom ëª¨ë“œì¼ ë•Œë§Œ)'
        required: false
        default: ''

      labels:
        description: 'ì²˜ë¦¬í•  ë¼ë²¨ (ì‰¼í‘œ êµ¬ë¶„, ë¹„ìš°ë©´ ì „ì²´)'
        required: false
        default: ''

# SKILL íŒŒì¼ ë° ê²°ê³¼ë¬¼ ìë™ ì»¤ë°‹ì„ ìœ„í•œ ê¶Œí•œ
permissions:
  contents: write

# ë™ì‹œ ì‹¤í–‰ ë°©ì§€ (ì´ì „ ì‹¤í–‰ì´ ëë‚  ë•Œê¹Œì§€ ëŒ€ê¸°)
concurrency:
  group: gmail-digest
  cancel-in-progress: false

jobs:
  process-emails:
    runs-on: ubuntu-latest
    timeout-minutes: 200

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check secrets
        id: check-secrets
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          GMAIL_CREDENTIALS: ${{ secrets.GMAIL_CREDENTIALS }}
          GMAIL_TOKEN: ${{ secrets.GMAIL_TOKEN }}
        run: |
          MISSING=""

          if [ -z "$OPENROUTER_API_KEY" ]; then
            MISSING="${MISSING}OPENROUTER_API_KEY, "
          fi

          if [ -z "$GMAIL_CREDENTIALS" ]; then
            MISSING="${MISSING}GMAIL_CREDENTIALS, "
          fi

          if [ -z "$GMAIL_TOKEN" ]; then
            MISSING="${MISSING}GMAIL_TOKEN, "
          fi

          if [ -n "$MISSING" ]; then
            echo "=========================================="
            echo "  GitHub Actions ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤"
            echo "=========================================="
            echo ""
            echo "ëˆ„ë½ëœ Secrets: ${MISSING%,*}"
            echo ""
            echo "ì„¤ì • ë°©ë²•:"
            echo "1. Repository â†’ Settings â†’ Secrets and variables â†’ Actions"
            echo "2. ë‹¤ìŒ Secrets ì¶”ê°€:"
            echo "   - OPENROUTER_API_KEY: OpenRouter API í‚¤"
            echo "   - GMAIL_CREDENTIALS: client_secret.json ë‚´ìš©"
            echo "   - GMAIL_TOKEN: token.json ë‚´ìš©"
            echo ""
            echo "ìì„¸í•œ ë‚´ìš©ì€ README.md ì°¸ì¡°"
            echo "=========================================="
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: ì‹œì‘ ì•Œë¦¼
        if: steps.check-secrets.outputs.skip != 'true'
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          INPUT_MODE: ${{ github.event.inputs.mode }}
          INPUT_DATE: ${{ github.event.inputs.custom_date }}
        run: |
          if [ -z "$TELEGRAM_TOKEN" ]; then
            echo "TELEGRAM_TOKENì´ ì„¤ì •ë˜ì§€ ì•Šì•„ ì‹œì‘ ì•Œë¦¼ì„ ê±´ë„ˆëœë‹ˆë‹¤."
            exit 0
          fi

          # ìš”ì²­í•œ ë‚ ì§œ ê²°ì • (custom ëª¨ë“œë©´ ì…ë ¥ê°’, ì•„ë‹ˆë©´ ì˜¤ëŠ˜)
          if [ "$INPUT_MODE" = "custom" ] && [ -n "$INPUT_DATE" ]; then
            # YYYY-MM-DD â†’ YYMMDD ë³€í™˜
            TARGET_DATE=$(echo "$INPUT_DATE" | sed 's/^20//' | tr -d '-')
          else
            TARGET_DATE=$(TZ='Asia/Seoul' date '+%y%m%d')
          fi

          MESSAGE=$(printf "ì•ˆë…•í•˜ì„¸ìš”:) ë‹¹ì‹ ì˜ Gmail ë§¤ë‹ˆì €ì…ë‹ˆë‹¤!\n%s ë‰´ìŠ¤ë ˆí„°ë¥¼ ì •ë¦¬í•´ ë“œë¦´ê²Œìš”.\nì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”!" "$TARGET_DATE")

          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d text="$MESSAGE"

      - name: Setup Node.js
        if: steps.check-secrets.outputs.skip != 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        if: steps.check-secrets.outputs.skip != 'true'
        run: npm install

      - name: Gmail ë©”ì¼ ì •ë¦¬ ì‹¤í–‰
        if: steps.check-secrets.outputs.skip != 'true'
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          GMAIL_CREDENTIALS: ${{ secrets.GMAIL_CREDENTIALS }}
          GMAIL_TOKEN: ${{ secrets.GMAIL_TOKEN }}
        run: |
          # .env íŒŒì¼ ìƒì„±
          echo "OPENROUTER_API_KEY=$OPENROUTER_API_KEY" > .env

          # Gmail credentials ì €ì¥ (config/credentials/ ê²½ë¡œë¡œ í†µì¼)
          mkdir -p config/credentials
          echo "$GMAIL_CREDENTIALS" > config/credentials/client_secret.json
          echo "$GMAIL_TOKEN" > config/credentials/token.json

          # ì‹¤í–‰ ëª¨ë“œ ê²°ì •
          if [ "${{ github.event_name }}" = "schedule" ]; then
            # ìë™ ì‹¤í–‰
            node scripts/orchestrator.js --mode schedule
          else
            # ìˆ˜ë™ ì‹¤í–‰
            MODE="${{ github.event.inputs.mode }}"
            CUSTOM_DATE="${{ github.event.inputs.custom_date }}"
            LABELS="${{ github.event.inputs.labels }}"

            ARGS="--mode $MODE"

            if [ -n "$CUSTOM_DATE" ]; then
              ARGS="$ARGS --date $CUSTOM_DATE"
            fi

            if [ -n "$LABELS" ]; then
              ARGS="$ARGS --labels $LABELS"
            fi

            node scripts/orchestrator.js $ARGS
          fi

      - name: SKILL íŒŒì¼ ë° ì„¤ì • ì»¤ë°‹
        if: success() && steps.check-secrets.outputs.skip != 'true'
        run: |
          # Git ì„¤ì •
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # ë³€ê²½ëœ SKILL íŒŒì¼ê³¼ newsletters.json í™•ì¸
          SKILL_CHANGES=$(git status --porcelain skills/newsletters/ 2>/dev/null | wc -l)
          CONFIG_CHANGES=$(git status --porcelain config/newsletters.json 2>/dev/null | wc -l)

          if [ "$SKILL_CHANGES" -gt 0 ] || [ "$CONFIG_CHANGES" -gt 0 ]; then
            echo "ìƒˆë¡œìš´ SKILL íŒŒì¼ ë˜ëŠ” ì„¤ì • ë³€ê²½ ê°ì§€ë¨"

            # íŒŒì¼ ì¶”ê°€
            git add skills/newsletters/*.md 2>/dev/null || true
            git add config/newsletters.json 2>/dev/null || true

            # ì»¤ë°‹ (ë³€ê²½ì‚¬í•­ì´ ìˆì„ ë•Œë§Œ)
            git diff --staged --quiet || git commit -m "chore: ìƒˆ ë‰´ìŠ¤ë ˆí„° SKILL ìë™ ìƒì„±"

            # í‘¸ì‹œ
            git push
            echo "SKILL íŒŒì¼ ì»¤ë°‹ ì™„ë£Œ"
          else
            echo "ìƒˆë¡œìš´ SKILL íŒŒì¼ ì—†ìŒ, ê±´ë„ˆëœ€"
          fi

      - name: ê²°ê³¼ë¬¼ main ë¸Œëœì¹˜ì— ì»¤ë°‹
        if: success() && steps.check-secrets.outputs.skip != 'true'
        run: |
          # output/final í´ë” í™•ì¸
          if [ -d "output/final" ] && [ "$(ls -A output/final 2>/dev/null)" ]; then
            echo "ê²°ê³¼ë¬¼ ë°œê²¬, main ë¸Œëœì¹˜ì— ì»¤ë°‹ ì‹œì‘"

            # Git ì„¤ì • (ì´ë¯¸ ì„¤ì •ë˜ì–´ ìˆì„ ìˆ˜ ìˆì§€ë§Œ ì•ˆì „í•˜ê²Œ)
            git config --local user.email "github-actions[bot]@users.noreply.github.com"
            git config --local user.name "github-actions[bot]"

            # ê²°ê³¼ë¬¼ ì¶”ê°€ (-f: .gitignore ë¬´ì‹œ)
            git add -f output/final/

            # ì»¤ë°‹ (ë³€ê²½ì‚¬í•­ì´ ìˆì„ ë•Œë§Œ)
            if ! git diff --staged --quiet; then
              TODAY=$(TZ='Asia/Seoul' date '+%Y-%m-%d')
              git commit -m "chore: ${TODAY} ë©”ì¼ ì •ë¦¬ ê²°ê³¼ë¬¼ ì €ì¥"
              git push
              echo "ê²°ê³¼ë¬¼ ì»¤ë°‹ ì™„ë£Œ"
            else
              echo "ìƒˆë¡œìš´ ê²°ê³¼ë¬¼ ì—†ìŒ"
            fi
          else
            echo "output/final í´ë”ê°€ ë¹„ì–´ìˆìŒ, ê±´ë„ˆëœ€"
          fi

      - name: ê²°ê³¼ë¬¼ ì—…ë¡œë“œ (MD íŒŒì¼)
        if: success() && steps.check-secrets.outputs.skip != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: mail-digest-md-${{ github.run_number }}
          path: output/final/**/*.md
          retention-days: 30

      - name: Telegram ì•Œë¦¼ ë° íŒŒì¼ ì „ì†¡
        if: success() && steps.check-secrets.outputs.skip != 'true'
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          # TELEGRAM_TOKENì´ ì—†ìœ¼ë©´ ê±´ë„ˆë›°ê¸°
          if [ -z "$TELEGRAM_TOKEN" ]; then
            echo "TELEGRAM_TOKENì´ ì„¤ì •ë˜ì§€ ì•Šì•„ ì•Œë¦¼ì„ ê±´ë„ˆëœë‹ˆë‹¤."
            exit 0
          fi

          # ë¼ë²¨ë³„ MD íŒŒì¼ ìˆ˜ (ë¼ë²¨ ê°œìˆ˜)
          MD_COUNT=$(find output/final -name "*_ë©”ì¼ì •ë¦¬.md" 2>/dev/null | grep -v "í†µí•©" | wc -l)

          # ë¼ë²¨ ëª©ë¡ ì¶”ì¶œ
          LABELS=$(find output/final -name "*_ë©”ì¼ì •ë¦¬.md" 2>/dev/null | grep -v "í†µí•©" | xargs -I {} basename {} | sed 's/^[0-9]*_//' | sed 's/_ë©”ì¼ì •ë¦¬.md$//' | tr '\n' ', ' | sed 's/,$//')

          # ë‚ ì§œ
          TODAY=$(TZ='Asia/Seoul' date '+%Y-%m-%d')

          # í†µí•© HTML íŒŒì¼ ì°¾ê¸°
          HTML_FILE=$(find output/final -name "*í†µí•©*ë©”ì¼ì •ë¦¬.html" 2>/dev/null | head -1)

          if [ -n "$HTML_FILE" ]; then
            # HTML íŒŒì¼ê³¼ í•¨ê»˜ ë©”ì‹œì§€ ì „ì†¡
            MESSAGE=$(printf "ğŸ“¬ Gmail ë©”ì¼ ì •ë¦¬ ì™„ë£Œ\n%s\n\në¼ë²¨: %s\n(%sê°œ ë¼ë²¨)" "$TODAY" "$LABELS" "$MD_COUNT")

            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendDocument" \
              -F chat_id="${TELEGRAM_CHAT_ID}" \
              -F document=@"${HTML_FILE}" \
              -F caption="${MESSAGE}"

            echo "HTML íŒŒì¼ ì „ì†¡ ì™„ë£Œ: ${HTML_FILE}"
          else
            # HTML íŒŒì¼ ì—†ìœ¼ë©´ ë©”ì‹œì§€ë§Œ ì „ì†¡
            MESSAGE=$(printf "ğŸ“¬ Gmail ë©”ì¼ ì •ë¦¬ ì™„ë£Œ\n%s\n\në¼ë²¨: %s\n(%sê°œ ë¼ë²¨)\n\n(ê²°ê³¼ë¬¼ ì—†ìŒ)" "$TODAY" "$LABELS" "$MD_COUNT")

            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
              -d chat_id="${TELEGRAM_CHAT_ID}" \
              -d text="$MESSAGE"
          fi

      - name: ì—ëŸ¬/íƒ€ì„ì•„ì›ƒ ì•Œë¦¼
        if: failure() || cancelled()
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          JOB_STATUS: ${{ job.status }}
        run: |
          # TELEGRAM_TOKENì´ ì—†ìœ¼ë©´ ê±´ë„ˆë›°ê¸°
          if [ -z "$TELEGRAM_TOKEN" ]; then
            echo "TELEGRAM_TOKENì´ ì„¤ì •ë˜ì§€ ì•Šì•„ ì—ëŸ¬ ì•Œë¦¼ì„ ê±´ë„ˆëœë‹ˆë‹¤."
            exit 0
          fi

          if [ "$JOB_STATUS" = "cancelled" ]; then
            MESSAGE=$(printf "[íƒ€ì„ì•„ì›ƒ] Gmail ë©”ì¼ ì •ë¦¬ê°€ ì‹œê°„ ì´ˆê³¼ë¡œ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.\n\në¡œê·¸ í™•ì¸: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}")
          else
            MESSAGE=$(printf "[ì‹¤íŒ¨] Gmail ë©”ì¼ ì •ë¦¬ ì‹¤íŒ¨\n\në¡œê·¸ í™•ì¸: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}")
          fi

          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d text="$MESSAGE"
