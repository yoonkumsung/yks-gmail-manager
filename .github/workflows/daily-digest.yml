name: Gmail ë©”ì¼ ì •ë¦¬

on:
  # ë§¤ì¼ ì˜¤ì „ 10ì‹œ KST ëª©í‘œ (GitHub Actions ì§€ì—° ê°ì•ˆí•˜ì—¬ 08:30 KST = 23:30 UTC ì„¤ì •)
  schedule:
    - cron: '30 23 * * *'

  # ìˆ˜ë™ ì‹¤í–‰ ë²„íŠ¼
  workflow_dispatch:
    inputs:
      mode:
        description: 'ì‹¤í–‰ ëª¨ë“œ'
        required: true
        default: 'today'
        type: choice
        options:
          - today        # ì˜¤ëŠ˜ 0ì‹œë¶€í„° í˜„ì¬ê¹Œì§€
          - last-24h     # 24ì‹œê°„ ì „ë¶€í„° í˜„ì¬ê¹Œì§€
          - custom       # íŠ¹ì • ë‚ ì§œ

      custom_date:
        description: 'íŠ¹ì • ë‚ ì§œ (YYYY-MM-DD, custom ëª¨ë“œì¼ ë•Œë§Œ)'
        required: false
        default: ''

      labels:
        description: 'ì²˜ë¦¬í•  ë¼ë²¨ (ì‰¼í‘œ êµ¬ë¶„, ë¹„ìš°ë©´ ì „ì²´)'
        required: false
        default: ''

# SKILL íŒŒì¼ ìë™ ì»¤ë°‹ì„ ìœ„í•œ ê¶Œí•œ
permissions:
  contents: write

# ë™ì‹œ ì‹¤í–‰ ë°©ì§€ (ì´ì „ ì‹¤í–‰ì´ ëë‚  ë•Œê¹Œì§€ ëŒ€ê¸°)
concurrency:
  group: gmail-digest
  cancel-in-progress: false

jobs:
  process-emails:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check secrets
        id: check-secrets
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          GMAIL_CREDENTIALS: ${{ secrets.GMAIL_CREDENTIALS }}
          GMAIL_TOKEN: ${{ secrets.GMAIL_TOKEN }}
        run: |
          MISSING=""

          if [ -z "$OPENROUTER_API_KEY" ]; then
            MISSING="${MISSING}OPENROUTER_API_KEY, "
          fi

          if [ -z "$GMAIL_CREDENTIALS" ]; then
            MISSING="${MISSING}GMAIL_CREDENTIALS, "
          fi

          if [ -z "$GMAIL_TOKEN" ]; then
            MISSING="${MISSING}GMAIL_TOKEN, "
          fi

          if [ -n "$MISSING" ]; then
            echo "=========================================="
            echo "  GitHub Actions ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤"
            echo "=========================================="
            echo ""
            echo "ëˆ„ë½ëœ Secrets: ${MISSING%,*}"
            echo ""
            echo "ì„¤ì • ë°©ë²•:"
            echo "1. Repository â†’ Settings â†’ Secrets and variables â†’ Actions"
            echo "2. ë‹¤ìŒ Secrets ì¶”ê°€:"
            echo "   - OPENROUTER_API_KEY: OpenRouter API í‚¤"
            echo "   - GMAIL_CREDENTIALS: client_secret.json ë‚´ìš©"
            echo "   - GMAIL_TOKEN: token.json ë‚´ìš©"
            echo ""
            echo "ìì„¸í•œ ë‚´ìš©ì€ README.md ì°¸ì¡°"
            echo "=========================================="
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: ì‹œì‘ ì•Œë¦¼
        id: start-notify
        if: steps.check-secrets.outputs.skip != 'true'
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          INPUT_MODE: ${{ github.event.inputs.mode }}
          INPUT_DATE: ${{ github.event.inputs.custom_date }}
          EVENT_NAME: ${{ github.event_name }}
        run: |
          # ì†Œìš”ì‹œê°„ ê³„ì‚°ìš© ì‹œì‘ ì‹œê° ì €ì¥
          echo "start_epoch=$(date +%s)" >> $GITHUB_OUTPUT

          if [ -z "$TELEGRAM_TOKEN" ]; then
            echo "TELEGRAM_TOKENì´ ì„¤ì •ë˜ì§€ ì•Šì•„ ì‹œì‘ ì•Œë¦¼ì„ ê±´ë„ˆëœë‹ˆë‹¤."
            exit 0
          fi

          # ëª¨ë“œ ê²°ì •
          if [ "$EVENT_NAME" = "schedule" ]; then
            MODE="schedule"
          else
            MODE="${INPUT_MODE:-today}"
          fi

          # ëª¨ë“œ í•œê¸€ í‘œì‹œ
          case "$MODE" in
            schedule) MODE_KR="ìŠ¤ì¼€ì¤„ (ì „ì¼)" ;;
            today)    MODE_KR="ì˜¤ëŠ˜" ;;
            last-24h) MODE_KR="ìµœê·¼ 24ì‹œê°„" ;;
            custom)   MODE_KR="ì§€ì •ì¼" ;;
            *)        MODE_KR="$MODE" ;;
          esac

          # ëŒ€ìƒ ë‚ ì§œ
          if [ "$MODE" = "custom" ] && [ -n "$INPUT_DATE" ]; then
            TARGET_DATE="$INPUT_DATE"
          else
            TARGET_DATE=$(TZ='Asia/Seoul' date '+%Y-%m-%d')
          fi

          MESSAGE=$(printf "[Gmail Manager] ë‰´ìŠ¤ë ˆí„° ì •ë¦¬ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.\n\nğŸ“… %s\nğŸ“‹ ëª¨ë“œ: %s" "$TARGET_DATE" "$MODE_KR")

          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d text="$MESSAGE" \
            -d parse_mode=HTML

      - name: Setup Node.js
        if: steps.check-secrets.outputs.skip != 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        if: steps.check-secrets.outputs.skip != 'true'
        run: npm install

      - name: Gmail ë©”ì¼ ì •ë¦¬ ì‹¤í–‰
        if: steps.check-secrets.outputs.skip != 'true'
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          GMAIL_CREDENTIALS: ${{ secrets.GMAIL_CREDENTIALS }}
          GMAIL_TOKEN: ${{ secrets.GMAIL_TOKEN }}
          USER_PROFILE: ${{ secrets.USER_PROFILE }}
          INPUT_MODE: ${{ github.event.inputs.mode }}
          INPUT_CUSTOM_DATE: ${{ github.event.inputs.custom_date }}
          INPUT_LABELS: ${{ github.event.inputs.labels }}
        run: |
          # .env íŒŒì¼ ìƒì„±
          echo "OPENROUTER_API_KEY=$OPENROUTER_API_KEY" > .env

          # Gmail credentials ì €ì¥ (config/credentials/ ê²½ë¡œë¡œ í†µì¼)
          mkdir -p config/credentials
          echo "$GMAIL_CREDENTIALS" > config/credentials/client_secret.json
          echo "$GMAIL_TOKEN" > config/credentials/token.json

          # ì‚¬ìš©ì í”„ë¡œí•„ ì €ì¥ (ì¸ì‚¬ì´íŠ¸ ê°œì¸í™”ìš©)
          if [ -n "$USER_PROFILE" ]; then
            echo "$USER_PROFILE" > config/user_profile.json
          fi

          # ì‹¤í–‰ ëª¨ë“œ ê²°ì •
          if [ "${{ github.event_name }}" = "schedule" ]; then
            # ìë™ ì‹¤í–‰
            node scripts/orchestrator.js --mode schedule
          else
            # ìˆ˜ë™ ì‹¤í–‰ (envë¡œ ì „ë‹¬ë°›ì•„ ì‰˜ ì¸ì ì…˜ ë°©ì§€)
            ARGS="--mode $INPUT_MODE"

            if [ -n "$INPUT_CUSTOM_DATE" ]; then
              ARGS="$ARGS --date $INPUT_CUSTOM_DATE"
            fi

            if [ -n "$INPUT_LABELS" ]; then
              ARGS="$ARGS --labels $INPUT_LABELS"
            fi

            node scripts/orchestrator.js $ARGS
          fi

      - name: SKILL íŒŒì¼ ë° ì„¤ì • ì»¤ë°‹
        if: success() && steps.check-secrets.outputs.skip != 'true'
        run: |
          # Git ì„¤ì •
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # ë³€ê²½ëœ SKILL íŒŒì¼ê³¼ newsletters.json í™•ì¸
          SKILL_CHANGES=$(git status --porcelain skills/newsletters/ 2>/dev/null | wc -l)
          CONFIG_CHANGES=$(git status --porcelain config/newsletters.json 2>/dev/null | wc -l)

          if [ "$SKILL_CHANGES" -gt 0 ] || [ "$CONFIG_CHANGES" -gt 0 ]; then
            echo "ìƒˆë¡œìš´ SKILL íŒŒì¼ ë˜ëŠ” ì„¤ì • ë³€ê²½ ê°ì§€ë¨"

            # íŒŒì¼ ì¶”ê°€
            git add skills/newsletters/*.md 2>/dev/null || true
            git add config/newsletters.json 2>/dev/null || true

            # ì»¤ë°‹ (ë³€ê²½ì‚¬í•­ì´ ìˆì„ ë•Œë§Œ)
            git diff --staged --quiet || git commit -m "chore: ìƒˆ ë‰´ìŠ¤ë ˆí„° SKILL ìë™ ìƒì„±"

            # í‘¸ì‹œ
            git push
            echo "SKILL íŒŒì¼ ì»¤ë°‹ ì™„ë£Œ"
          else
            echo "ìƒˆë¡œìš´ SKILL íŒŒì¼ ì—†ìŒ, ê±´ë„ˆëœ€"
          fi

      - name: ê²°ê³¼ë¬¼ ì—…ë¡œë“œ (Artifacts)
        if: success() && steps.check-secrets.outputs.skip != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: mail-digest-${{ github.run_number }}
          path: |
            output/final/**/*.md
            output/final/**/*.html
          retention-days: 30

      - name: Telegram ì•Œë¦¼ ë° íŒŒì¼ ì „ì†¡
        if: success() && steps.check-secrets.outputs.skip != 'true'
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          INPUT_MODE: ${{ github.event.inputs.mode }}
          INPUT_DATE: ${{ github.event.inputs.custom_date }}
          START_EPOCH: ${{ steps.start-notify.outputs.start_epoch }}
        run: |
          # TELEGRAM_TOKENì´ ì—†ìœ¼ë©´ ê±´ë„ˆë›°ê¸°
          if [ -z "$TELEGRAM_TOKEN" ]; then
            echo "TELEGRAM_TOKENì´ ì„¤ì •ë˜ì§€ ì•Šì•„ ì•Œë¦¼ì„ ê±´ë„ˆëœë‹ˆë‹¤."
            exit 0
          fi

          # ì†Œìš”ì‹œê°„ ê³„ì‚°
          END_EPOCH=$(date +%s)
          ELAPSED=$(( END_EPOCH - START_EPOCH ))
          ELAPSED_MIN=$(( ELAPSED / 60 ))
          ELAPSED_SEC=$(( ELAPSED % 60 ))

          # í˜„ì¬ ì‹¤í–‰ì˜ RunID ê³„ì‚° (YYYYMMDD)
          if [ "$INPUT_MODE" = "custom" ] && [ -n "$INPUT_DATE" ]; then
            RUN_ID=$(echo "$INPUT_DATE" | tr -d '-')
            TARGET_DATE="$INPUT_DATE"
          else
            RUN_ID=$(TZ='Asia/Seoul' date '+%Y%m%d')
            TARGET_DATE=$(TZ='Asia/Seoul' date '+%Y-%m-%d')
          fi

          # ê²°ê³¼ë¬¼ í´ë” í™•ì¸
          RUN_DIR="output/final/${RUN_ID}"

          if [ ! -d "$RUN_DIR" ]; then
            MESSAGE=$(printf "[Gmail Manager] ë‰´ìŠ¤ë ˆí„° ì •ë¦¬ ì™„ë£Œ\n\nğŸ“… %s\nğŸ“Š ì²˜ë¦¬í•  ë‰´ìŠ¤ë ˆí„°ê°€ ì—†ì—ˆìŠµë‹ˆë‹¤.\nâ± %dë¶„ %dì´ˆ" "$TARGET_DATE" "$ELAPSED_MIN" "$ELAPSED_SEC")
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
              -d chat_id="${TELEGRAM_CHAT_ID}" \
              -d text="$MESSAGE" \
              -d parse_mode=HTML
            exit 0
          fi

          # ê²°ê³¼ ì§‘ê³„
          LABEL_COUNT=$(find "$RUN_DIR" -name "*_ë©”ì¼ì •ë¦¬.md" 2>/dev/null | grep -v "í†µí•©" | wc -l | tr -d ' ')
          LABEL_NAMES=$(find "$RUN_DIR" -name "*_ë©”ì¼ì •ë¦¬.md" 2>/dev/null | grep -v "í†µí•©" | xargs -I {} basename {} | sed 's/^[0-9]*_//' | sed 's/_ë©”ì¼ì •ë¦¬.md$//' | tr '\n' ', ' | sed 's/,$//')

          # í†µí•© íŒŒì¼ ì°¾ê¸°
          HTML_FILE=$(find "$RUN_DIR" -name "*í†µí•©*ë©”ì¼ì •ë¦¬.html" 2>/dev/null | head -1)
          MD_FILE=$(find "$RUN_DIR" -name "*í†µí•©*ë©”ì¼ì •ë¦¬.md" 2>/dev/null | head -1)

          # ì™„ë£Œ ë©”ì‹œì§€ ë¨¼ì € ì „ì†¡
          MESSAGE=$(printf "[Gmail Manager] ë‰´ìŠ¤ë ˆí„° ì •ë¦¬ ì™„ë£Œ\n\nğŸ“… %s\nğŸ“Š %sê°œ ë¼ë²¨ ì²˜ë¦¬ ì™„ë£Œ\nâ± %dë¶„ %dì´ˆ" "$TARGET_DATE" "$LABEL_COUNT" "$ELAPSED_MIN" "$ELAPSED_SEC")

          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d text="$MESSAGE" \
            -d parse_mode=HTML

          # íŒŒì¼ ì „ì†¡ (caption ì—†ì´ ë‹¨ìˆœ ì²¨ë¶€)
          if [ -n "$HTML_FILE" ]; then
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendDocument" \
              -F chat_id="${TELEGRAM_CHAT_ID}" \
              -F document=@"${HTML_FILE}"
          fi

          if [ -n "$MD_FILE" ]; then
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendDocument" \
              -F chat_id="${TELEGRAM_CHAT_ID}" \
              -F document=@"${MD_FILE}"
          fi

      - name: ì—ëŸ¬/íƒ€ì„ì•„ì›ƒ ì•Œë¦¼
        if: failure() || cancelled()
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          JOB_STATUS: ${{ job.status }}
          START_EPOCH: ${{ steps.start-notify.outputs.start_epoch }}
        run: |
          if [ -z "$TELEGRAM_TOKEN" ]; then
            echo "TELEGRAM_TOKENì´ ì„¤ì •ë˜ì§€ ì•Šì•„ ì—ëŸ¬ ì•Œë¦¼ì„ ê±´ë„ˆëœë‹ˆë‹¤."
            exit 0
          fi

          # ì†Œìš”ì‹œê°„ ê³„ì‚°
          END_EPOCH=$(date +%s)
          if [ -n "$START_EPOCH" ]; then
            ELAPSED=$(( END_EPOCH - START_EPOCH ))
            ELAPSED_MIN=$(( ELAPSED / 60 ))
            ELAPSED_SEC=$(( ELAPSED % 60 ))
            ELAPSED_STR=$(printf "%dë¶„ %dì´ˆ" "$ELAPSED_MIN" "$ELAPSED_SEC")
          else
            ELAPSED_STR="-"
          fi

          TARGET_DATE=$(TZ='Asia/Seoul' date '+%Y-%m-%d')
          LOG_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          if [ "$JOB_STATUS" = "cancelled" ]; then
            STATUS="íƒ€ì„ì•„ì›ƒ"
          else
            STATUS="ì—ëŸ¬"
          fi

          MESSAGE=$(printf "[Gmail Manager] ë‰´ìŠ¤ë ˆí„° ì •ë¦¬ ì‹¤íŒ¨\n\nğŸ“… %s\nâŒ ìƒíƒœ: %s\nâ± %s\n\nğŸ”— <a href=\"%s\">ë¡œê·¸ í™•ì¸</a>" "$TARGET_DATE" "$STATUS" "$ELAPSED_STR" "$LOG_URL")

          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d text="$MESSAGE" \
            -d parse_mode=HTML
