name: Gmail 메일 정리

on:
  # 매일 오전 10시 KST 목표 (GitHub Actions 지연 감안하여 08:30 KST = 23:30 UTC 설정)
  schedule:
    - cron: '30 23 * * *'

  # 수동 실행 버튼
  workflow_dispatch:
    inputs:
      mode:
        description: '실행 모드'
        required: true
        default: 'today'
        type: choice
        options:
          - today        # 오늘 0시부터 현재까지
          - last-24h     # 24시간 전부터 현재까지
          - custom       # 특정 날짜

      custom_date:
        description: '특정 날짜 (YYYY-MM-DD, custom 모드일 때만)'
        required: false
        default: ''

      labels:
        description: '처리할 라벨 (쉼표 구분, 비우면 전체)'
        required: false
        default: ''

# SKILL 파일 및 결과물 자동 커밋을 위한 권한
permissions:
  contents: write

# 동시 실행 방지 (이전 실행이 끝날 때까지 대기)
concurrency:
  group: gmail-digest
  cancel-in-progress: false

jobs:
  process-emails:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check secrets
        id: check-secrets
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          GMAIL_CREDENTIALS: ${{ secrets.GMAIL_CREDENTIALS }}
          GMAIL_TOKEN: ${{ secrets.GMAIL_TOKEN }}
        run: |
          MISSING=""

          if [ -z "$OPENROUTER_API_KEY" ]; then
            MISSING="${MISSING}OPENROUTER_API_KEY, "
          fi

          if [ -z "$GMAIL_CREDENTIALS" ]; then
            MISSING="${MISSING}GMAIL_CREDENTIALS, "
          fi

          if [ -z "$GMAIL_TOKEN" ]; then
            MISSING="${MISSING}GMAIL_TOKEN, "
          fi

          if [ -n "$MISSING" ]; then
            echo "=========================================="
            echo "  GitHub Actions 설정이 필요합니다"
            echo "=========================================="
            echo ""
            echo "누락된 Secrets: ${MISSING%,*}"
            echo ""
            echo "설정 방법:"
            echo "1. Repository → Settings → Secrets and variables → Actions"
            echo "2. 다음 Secrets 추가:"
            echo "   - OPENROUTER_API_KEY: OpenRouter API 키"
            echo "   - GMAIL_CREDENTIALS: client_secret.json 내용"
            echo "   - GMAIL_TOKEN: token.json 내용"
            echo ""
            echo "자세한 내용은 README.md 참조"
            echo "=========================================="
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: 시작 알림
        if: steps.check-secrets.outputs.skip != 'true'
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          INPUT_MODE: ${{ github.event.inputs.mode }}
          INPUT_DATE: ${{ github.event.inputs.custom_date }}
        run: |
          if [ -z "$TELEGRAM_TOKEN" ]; then
            echo "TELEGRAM_TOKEN이 설정되지 않아 시작 알림을 건너뜁니다."
            exit 0
          fi

          # 요청한 날짜 결정 (custom 모드면 입력값, 아니면 오늘)
          if [ "$INPUT_MODE" = "custom" ] && [ -n "$INPUT_DATE" ]; then
            # YYYY-MM-DD → YYMMDD 변환
            TARGET_DATE=$(echo "$INPUT_DATE" | sed 's/^20//' | tr -d '-')
          else
            TARGET_DATE=$(TZ='Asia/Seoul' date '+%y%m%d')
          fi

          MESSAGE=$(printf "안녕하세요:) 당신의 Gmail 매니저입니다!\n%s 뉴스레터를 정리해 드릴게요.\n잠시만 기다려주세요!" "$TARGET_DATE")

          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d text="$MESSAGE"

      - name: Setup Node.js
        if: steps.check-secrets.outputs.skip != 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        if: steps.check-secrets.outputs.skip != 'true'
        run: npm install

      - name: Gmail 메일 정리 실행
        if: steps.check-secrets.outputs.skip != 'true'
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          GMAIL_CREDENTIALS: ${{ secrets.GMAIL_CREDENTIALS }}
          GMAIL_TOKEN: ${{ secrets.GMAIL_TOKEN }}
        run: |
          # .env 파일 생성
          echo "OPENROUTER_API_KEY=$OPENROUTER_API_KEY" > .env

          # Gmail credentials 저장 (config/credentials/ 경로로 통일)
          mkdir -p config/credentials
          echo "$GMAIL_CREDENTIALS" > config/credentials/client_secret.json
          echo "$GMAIL_TOKEN" > config/credentials/token.json

          # 실행 모드 결정
          if [ "${{ github.event_name }}" = "schedule" ]; then
            # 자동 실행
            node scripts/orchestrator.js --mode schedule
          else
            # 수동 실행
            MODE="${{ github.event.inputs.mode }}"
            CUSTOM_DATE="${{ github.event.inputs.custom_date }}"
            LABELS="${{ github.event.inputs.labels }}"

            ARGS="--mode $MODE"

            if [ -n "$CUSTOM_DATE" ]; then
              ARGS="$ARGS --date $CUSTOM_DATE"
            fi

            if [ -n "$LABELS" ]; then
              ARGS="$ARGS --labels $LABELS"
            fi

            node scripts/orchestrator.js $ARGS
          fi

      - name: SKILL 파일 및 설정 커밋
        if: success() && steps.check-secrets.outputs.skip != 'true'
        run: |
          # Git 설정
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # 변경된 SKILL 파일과 newsletters.json 확인
          SKILL_CHANGES=$(git status --porcelain skills/newsletters/ 2>/dev/null | wc -l)
          CONFIG_CHANGES=$(git status --porcelain config/newsletters.json 2>/dev/null | wc -l)

          if [ "$SKILL_CHANGES" -gt 0 ] || [ "$CONFIG_CHANGES" -gt 0 ]; then
            echo "새로운 SKILL 파일 또는 설정 변경 감지됨"

            # 파일 추가
            git add skills/newsletters/*.md 2>/dev/null || true
            git add config/newsletters.json 2>/dev/null || true

            # 커밋 (변경사항이 있을 때만)
            git diff --staged --quiet || git commit -m "chore: 새 뉴스레터 SKILL 자동 생성"

            # 푸시
            git push
            echo "SKILL 파일 커밋 완료"
          else
            echo "새로운 SKILL 파일 없음, 건너뜀"
          fi

      - name: 결과물 main 브랜치에 커밋
        if: success() && steps.check-secrets.outputs.skip != 'true'
        run: |
          # output/final 폴더 확인
          if [ -d "output/final" ] && [ "$(ls -A output/final 2>/dev/null)" ]; then
            echo "결과물 발견, main 브랜치에 커밋 시작"

            # Git 설정 (이미 설정되어 있을 수 있지만 안전하게)
            git config --local user.email "github-actions[bot]@users.noreply.github.com"
            git config --local user.name "github-actions[bot]"

            # 결과물 추가 (-f: .gitignore 무시)
            git add -f output/final/

            # 커밋 (변경사항이 있을 때만)
            if ! git diff --staged --quiet; then
              TODAY=$(TZ='Asia/Seoul' date '+%Y-%m-%d')
              git commit -m "chore: ${TODAY} 메일 정리 결과물 저장"
              git push
              echo "결과물 커밋 완료"
            else
              echo "새로운 결과물 없음"
            fi
          else
            echo "output/final 폴더가 비어있음, 건너뜀"
          fi

      - name: 결과물 업로드 (MD 파일)
        if: success() && steps.check-secrets.outputs.skip != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: mail-digest-md-${{ github.run_number }}
          path: output/final/**/*.md
          retention-days: 30

      - name: Telegram 알림 및 파일 전송
        if: success() && steps.check-secrets.outputs.skip != 'true'
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          INPUT_MODE: ${{ github.event.inputs.mode }}
          INPUT_DATE: ${{ github.event.inputs.custom_date }}
        run: |
          # TELEGRAM_TOKEN이 없으면 건너뛰기
          if [ -z "$TELEGRAM_TOKEN" ]; then
            echo "TELEGRAM_TOKEN이 설정되지 않아 알림을 건너뜁니다."
            exit 0
          fi

          # 현재 실행의 RunID 계산 (YYYYMMDD)
          if [ "$INPUT_MODE" = "custom" ] && [ -n "$INPUT_DATE" ]; then
            RUN_ID=$(echo "$INPUT_DATE" | tr -d '-')
          else
            RUN_ID=$(TZ='Asia/Seoul' date '+%Y%m%d')
          fi
          echo "현재 RunID: $RUN_ID"

          # 현재 실행의 결과물 폴더만 검색 (이전 실행 결과 제외)
          RUN_DIR="output/final/${RUN_ID}"

          if [ ! -d "$RUN_DIR" ]; then
            echo "결과물 폴더 없음: $RUN_DIR"
            MESSAGE=$(printf "Gmail 메일 정리 완료\n%s\n\n처리된 메일이 없습니다." "$(TZ='Asia/Seoul' date '+%Y-%m-%d')")
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
              -d chat_id="${TELEGRAM_CHAT_ID}" \
              -d text="$MESSAGE"
            exit 0
          fi

          # 현재 실행 결과물에서만 검색
          MD_COUNT=$(find "$RUN_DIR" -name "*_메일정리.md" 2>/dev/null | grep -v "통합" | wc -l)
          LABELS=$(find "$RUN_DIR" -name "*_메일정리.md" 2>/dev/null | grep -v "통합" | xargs -I {} basename {} | sed 's/^[0-9]*_//' | sed 's/_메일정리.md$//' | tr '\n' ', ' | sed 's/,$//')
          TODAY=$(TZ='Asia/Seoul' date '+%Y-%m-%d')

          # 현재 실행의 통합 HTML만 찾기
          HTML_FILE=$(find "$RUN_DIR" -name "*통합*메일정리.html" 2>/dev/null | head -1)

          if [ -n "$HTML_FILE" ]; then
            MESSAGE=$(printf "Gmail 메일 정리 완료\n%s\n\n라벨: %s\n(%s개 라벨)" "$TODAY" "$LABELS" "$MD_COUNT")

            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendDocument" \
              -F chat_id="${TELEGRAM_CHAT_ID}" \
              -F document=@"${HTML_FILE}" \
              -F caption="${MESSAGE}"

            echo "HTML 파일 전송 완료: ${HTML_FILE}"
          else
            MESSAGE=$(printf "Gmail 메일 정리 완료\n%s\n\n라벨: %s\n(%s개 라벨)\n\n(HTML 파일 없음)" "$TODAY" "$LABELS" "$MD_COUNT")

            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
              -d chat_id="${TELEGRAM_CHAT_ID}" \
              -d text="$MESSAGE"
          fi

      - name: 에러/타임아웃 알림
        if: failure() || cancelled()
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          JOB_STATUS: ${{ job.status }}
        run: |
          # TELEGRAM_TOKEN이 없으면 건너뛰기
          if [ -z "$TELEGRAM_TOKEN" ]; then
            echo "TELEGRAM_TOKEN이 설정되지 않아 에러 알림을 건너뜁니다."
            exit 0
          fi

          if [ "$JOB_STATUS" = "cancelled" ]; then
            MESSAGE=$(printf "[타임아웃] Gmail 메일 정리가 시간 초과로 취소되었습니다.\n\n로그 확인: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}")
          else
            MESSAGE=$(printf "[실패] Gmail 메일 정리 실패\n\n로그 확인: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}")
          fi

          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d text="$MESSAGE"
