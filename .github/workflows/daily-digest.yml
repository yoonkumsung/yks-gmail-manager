name: Gmail 메일 정리

on:
  # 매일 오전 10시 KST 목표 (GitHub Actions 지연 감안하여 08:30 KST = 23:30 UTC 설정)
  schedule:
    - cron: '30 23 * * *'

  # 수동 실행 버튼
  workflow_dispatch:
    inputs:
      mode:
        description: '실행 모드'
        required: true
        default: 'today'
        type: choice
        options:
          - today        # 오늘 0시부터 현재까지
          - last-24h     # 24시간 전부터 현재까지
          - custom       # 특정 날짜

      custom_date:
        description: '특정 날짜 (YYYY-MM-DD, custom 모드일 때만)'
        required: false
        default: ''

      labels:
        description: '처리할 라벨 (쉼표 구분, 비우면 전체)'
        required: false
        default: ''

# SKILL 파일 자동 커밋을 위한 권한
permissions:
  contents: write

# 동시 실행 방지 (이전 실행이 끝날 때까지 대기)
concurrency:
  group: gmail-digest
  cancel-in-progress: false

jobs:
  process-emails:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check secrets
        id: check-secrets
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          GMAIL_CREDENTIALS: ${{ secrets.GMAIL_CREDENTIALS }}
          GMAIL_TOKEN: ${{ secrets.GMAIL_TOKEN }}
        run: |
          MISSING=""

          if [ -z "$OPENROUTER_API_KEY" ]; then
            MISSING="${MISSING}OPENROUTER_API_KEY, "
          fi

          if [ -z "$GMAIL_CREDENTIALS" ]; then
            MISSING="${MISSING}GMAIL_CREDENTIALS, "
          fi

          if [ -z "$GMAIL_TOKEN" ]; then
            MISSING="${MISSING}GMAIL_TOKEN, "
          fi

          if [ -n "$MISSING" ]; then
            echo "=========================================="
            echo "  GitHub Actions 설정이 필요합니다"
            echo "=========================================="
            echo ""
            echo "누락된 Secrets: ${MISSING%,*}"
            echo ""
            echo "설정 방법:"
            echo "1. Repository → Settings → Secrets and variables → Actions"
            echo "2. 다음 Secrets 추가:"
            echo "   - OPENROUTER_API_KEY: OpenRouter API 키"
            echo "   - GMAIL_CREDENTIALS: client_secret.json 내용"
            echo "   - GMAIL_TOKEN: token.json 내용"
            echo ""
            echo "자세한 내용은 README.md 참조"
            echo "=========================================="
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: 시작 알림
        id: start-notify
        if: steps.check-secrets.outputs.skip != 'true'
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          INPUT_MODE: ${{ github.event.inputs.mode }}
          INPUT_DATE: ${{ github.event.inputs.custom_date }}
          EVENT_NAME: ${{ github.event_name }}
        run: |
          # 소요시간 계산용 시작 시각 저장
          echo "start_epoch=$(date +%s)" >> $GITHUB_OUTPUT

          if [ -z "$TELEGRAM_TOKEN" ]; then
            echo "TELEGRAM_TOKEN이 설정되지 않아 시작 알림을 건너뜁니다."
            exit 0
          fi

          # 모드 결정
          if [ "$EVENT_NAME" = "schedule" ]; then
            MODE="schedule"
          else
            MODE="${INPUT_MODE:-today}"
          fi

          # 모드 한글 표시
          case "$MODE" in
            schedule) MODE_KR="스케줄 (전일)" ;;
            today)    MODE_KR="오늘" ;;
            last-24h) MODE_KR="최근 24시간" ;;
            custom)   MODE_KR="지정일" ;;
            *)        MODE_KR="$MODE" ;;
          esac

          # 대상 날짜
          if [ "$MODE" = "custom" ] && [ -n "$INPUT_DATE" ]; then
            TARGET_DATE="$INPUT_DATE"
          else
            TARGET_DATE=$(TZ='Asia/Seoul' date '+%Y-%m-%d')
          fi

          MESSAGE=$(printf "[뉴스레터 정리 시작]\n날짜: %s\n모드: %s" "$TARGET_DATE" "$MODE_KR")

          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d text="$MESSAGE"

      - name: Setup Node.js
        if: steps.check-secrets.outputs.skip != 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        if: steps.check-secrets.outputs.skip != 'true'
        run: npm install

      - name: Gmail 메일 정리 실행
        if: steps.check-secrets.outputs.skip != 'true'
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          GMAIL_CREDENTIALS: ${{ secrets.GMAIL_CREDENTIALS }}
          GMAIL_TOKEN: ${{ secrets.GMAIL_TOKEN }}
          USER_PROFILE: ${{ secrets.USER_PROFILE }}
        run: |
          # .env 파일 생성
          echo "OPENROUTER_API_KEY=$OPENROUTER_API_KEY" > .env

          # Gmail credentials 저장 (config/credentials/ 경로로 통일)
          mkdir -p config/credentials
          echo "$GMAIL_CREDENTIALS" > config/credentials/client_secret.json
          echo "$GMAIL_TOKEN" > config/credentials/token.json

          # 사용자 프로필 저장 (인사이트 개인화용)
          if [ -n "$USER_PROFILE" ]; then
            echo "$USER_PROFILE" > config/user_profile.json
          fi

          # 실행 모드 결정
          if [ "${{ github.event_name }}" = "schedule" ]; then
            # 자동 실행
            node scripts/orchestrator.js --mode schedule
          else
            # 수동 실행
            MODE="${{ github.event.inputs.mode }}"
            CUSTOM_DATE="${{ github.event.inputs.custom_date }}"
            LABELS="${{ github.event.inputs.labels }}"

            ARGS="--mode $MODE"

            if [ -n "$CUSTOM_DATE" ]; then
              ARGS="$ARGS --date $CUSTOM_DATE"
            fi

            if [ -n "$LABELS" ]; then
              ARGS="$ARGS --labels $LABELS"
            fi

            node scripts/orchestrator.js $ARGS
          fi

      - name: SKILL 파일 및 설정 커밋
        if: success() && steps.check-secrets.outputs.skip != 'true'
        run: |
          # Git 설정
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # 변경된 SKILL 파일과 newsletters.json 확인
          SKILL_CHANGES=$(git status --porcelain skills/newsletters/ 2>/dev/null | wc -l)
          CONFIG_CHANGES=$(git status --porcelain config/newsletters.json 2>/dev/null | wc -l)

          if [ "$SKILL_CHANGES" -gt 0 ] || [ "$CONFIG_CHANGES" -gt 0 ]; then
            echo "새로운 SKILL 파일 또는 설정 변경 감지됨"

            # 파일 추가
            git add skills/newsletters/*.md 2>/dev/null || true
            git add config/newsletters.json 2>/dev/null || true

            # 커밋 (변경사항이 있을 때만)
            git diff --staged --quiet || git commit -m "chore: 새 뉴스레터 SKILL 자동 생성"

            # 푸시
            git push
            echo "SKILL 파일 커밋 완료"
          else
            echo "새로운 SKILL 파일 없음, 건너뜀"
          fi

      - name: 결과물 업로드 (Artifacts)
        if: success() && steps.check-secrets.outputs.skip != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: mail-digest-${{ github.run_number }}
          path: |
            output/final/**/*.md
            output/final/**/*.html
          retention-days: 30

      - name: Telegram 알림 및 파일 전송
        if: success() && steps.check-secrets.outputs.skip != 'true'
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          INPUT_MODE: ${{ github.event.inputs.mode }}
          INPUT_DATE: ${{ github.event.inputs.custom_date }}
          START_EPOCH: ${{ steps.start-notify.outputs.start_epoch }}
        run: |
          # TELEGRAM_TOKEN이 없으면 건너뛰기
          if [ -z "$TELEGRAM_TOKEN" ]; then
            echo "TELEGRAM_TOKEN이 설정되지 않아 알림을 건너뜁니다."
            exit 0
          fi

          # 소요시간 계산
          END_EPOCH=$(date +%s)
          ELAPSED=$(( END_EPOCH - START_EPOCH ))
          ELAPSED_MIN=$(( ELAPSED / 60 ))
          ELAPSED_SEC=$(( ELAPSED % 60 ))

          # 현재 실행의 RunID 계산 (YYYYMMDD)
          if [ "$INPUT_MODE" = "custom" ] && [ -n "$INPUT_DATE" ]; then
            RUN_ID=$(echo "$INPUT_DATE" | tr -d '-')
            TARGET_DATE="$INPUT_DATE"
          else
            RUN_ID=$(TZ='Asia/Seoul' date '+%Y%m%d')
            TARGET_DATE=$(TZ='Asia/Seoul' date '+%Y-%m-%d')
          fi

          # 결과물 폴더 확인
          RUN_DIR="output/final/${RUN_ID}"

          if [ ! -d "$RUN_DIR" ]; then
            MESSAGE=$(printf "[뉴스레터 정리 완료]\n날짜: %s\n소요: %d분 %d초\n\n처리된 뉴스레터가 없습니다." "$TARGET_DATE" "$ELAPSED_MIN" "$ELAPSED_SEC")
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
              -d chat_id="${TELEGRAM_CHAT_ID}" \
              -d text="$MESSAGE"
            exit 0
          fi

          # 결과 집계
          LABEL_COUNT=$(find "$RUN_DIR" -name "*_메일정리.md" 2>/dev/null | grep -v "통합" | wc -l | tr -d ' ')
          LABEL_NAMES=$(find "$RUN_DIR" -name "*_메일정리.md" 2>/dev/null | grep -v "통합" | xargs -I {} basename {} | sed 's/^[0-9]*_//' | sed 's/_메일정리.md$//' | tr '\n' ', ' | sed 's/,$//')

          # 통합 파일 찾기
          HTML_FILE=$(find "$RUN_DIR" -name "*통합*메일정리.html" 2>/dev/null | head -1)
          MD_FILE=$(find "$RUN_DIR" -name "*통합*메일정리.md" 2>/dev/null | head -1)

          MESSAGE=$(printf "[뉴스레터 정리 완료]\n날짜: %s\n라벨: %s (%s개)\n소요: %d분 %d초" "$TARGET_DATE" "$LABEL_NAMES" "$LABEL_COUNT" "$ELAPSED_MIN" "$ELAPSED_SEC")

          if [ -n "$HTML_FILE" ]; then
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendDocument" \
              -F chat_id="${TELEGRAM_CHAT_ID}" \
              -F document=@"${HTML_FILE}" \
              -F caption="${MESSAGE}"

            if [ -n "$MD_FILE" ]; then
              curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendDocument" \
                -F chat_id="${TELEGRAM_CHAT_ID}" \
                -F document=@"${MD_FILE}" \
                -F caption="Markdown"
            fi
          else
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
              -d chat_id="${TELEGRAM_CHAT_ID}" \
              -d text="$MESSAGE"
          fi

      - name: 에러/타임아웃 알림
        if: failure() || cancelled()
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          JOB_STATUS: ${{ job.status }}
          START_EPOCH: ${{ steps.start-notify.outputs.start_epoch }}
        run: |
          if [ -z "$TELEGRAM_TOKEN" ]; then
            echo "TELEGRAM_TOKEN이 설정되지 않아 에러 알림을 건너뜁니다."
            exit 0
          fi

          # 소요시간 계산
          END_EPOCH=$(date +%s)
          if [ -n "$START_EPOCH" ]; then
            ELAPSED=$(( END_EPOCH - START_EPOCH ))
            ELAPSED_MIN=$(( ELAPSED / 60 ))
            ELAPSED_SEC=$(( ELAPSED % 60 ))
            ELAPSED_STR=$(printf "%d분 %d초" "$ELAPSED_MIN" "$ELAPSED_SEC")
          else
            ELAPSED_STR="-"
          fi

          TARGET_DATE=$(TZ='Asia/Seoul' date '+%Y-%m-%d')
          LOG_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          if [ "$JOB_STATUS" = "cancelled" ]; then
            STATUS="타임아웃"
          else
            STATUS="에러"
          fi

          MESSAGE=$(printf "[뉴스레터 정리 실패]\n날짜: %s\n상태: %s\n소요: %s\n\n로그: %s" "$TARGET_DATE" "$STATUS" "$ELAPSED_STR" "$LOG_URL")

          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d text="$MESSAGE"
