name: Gmail 메일 정리

on:
  # 매일 오전 10시 KST = 01:00 UTC
  schedule:
    - cron: '0 1 * * *'

  # 수동 실행 버튼
  workflow_dispatch:
    inputs:
      mode:
        description: '실행 모드'
        required: true
        default: 'last-24h'
        type: choice
        options:
          - today        # 오늘 0시부터 현재까지
          - last-24h     # 24시간 전부터 현재까지
          - custom       # 특정 날짜

      custom_date:
        description: '특정 날짜 (YYYY-MM-DD, custom 모드일 때만)'
        required: false
        default: ''

      labels:
        description: '처리할 라벨 (쉼표 구분, 비우면 전체)'
        required: false
        default: ''

jobs:
  process-emails:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check secrets
        id: check-secrets
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          GMAIL_CREDENTIALS: ${{ secrets.GMAIL_CREDENTIALS }}
          GMAIL_TOKEN: ${{ secrets.GMAIL_TOKEN }}
        run: |
          MISSING=""

          if [ -z "$OPENROUTER_API_KEY" ]; then
            MISSING="${MISSING}OPENROUTER_API_KEY, "
          fi

          if [ -z "$GMAIL_CREDENTIALS" ]; then
            MISSING="${MISSING}GMAIL_CREDENTIALS, "
          fi

          if [ -z "$GMAIL_TOKEN" ]; then
            MISSING="${MISSING}GMAIL_TOKEN, "
          fi

          if [ -n "$MISSING" ]; then
            echo "=========================================="
            echo "  GitHub Actions 설정이 필요합니다"
            echo "=========================================="
            echo ""
            echo "누락된 Secrets: ${MISSING%,*}"
            echo ""
            echo "설정 방법:"
            echo "1. Repository → Settings → Secrets and variables → Actions"
            echo "2. 다음 Secrets 추가:"
            echo "   - OPENROUTER_API_KEY: OpenRouter API 키"
            echo "   - GMAIL_CREDENTIALS: client_secret.json 내용"
            echo "   - GMAIL_TOKEN: token.json 내용"
            echo ""
            echo "자세한 내용은 README.md 참조"
            echo "=========================================="
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Node.js
        if: steps.check-secrets.outputs.skip != 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        if: steps.check-secrets.outputs.skip != 'true'
        run: npm install

      - name: Gmail 메일 정리 실행
        if: steps.check-secrets.outputs.skip != 'true'
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          GMAIL_CREDENTIALS: ${{ secrets.GMAIL_CREDENTIALS }}
          GMAIL_TOKEN: ${{ secrets.GMAIL_TOKEN }}
        run: |
          # .env 파일 생성
          echo "OPENROUTER_API_KEY=$OPENROUTER_API_KEY" > .env

          # Gmail credentials 저장 (config/credentials/ 경로로 통일)
          mkdir -p config/credentials
          echo "$GMAIL_CREDENTIALS" > config/credentials/client_secret.json
          echo "$GMAIL_TOKEN" > config/credentials/token.json

          # 실행 모드 결정
          if [ "${{ github.event_name }}" = "schedule" ]; then
            # 자동 실행
            node scripts/orchestrator.js --mode schedule
          else
            # 수동 실행
            MODE="${{ github.event.inputs.mode }}"
            CUSTOM_DATE="${{ github.event.inputs.custom_date }}"
            LABELS="${{ github.event.inputs.labels }}"

            ARGS="--mode $MODE"

            if [ -n "$CUSTOM_DATE" ]; then
              ARGS="$ARGS --date $CUSTOM_DATE"
            fi

            if [ -n "$LABELS" ]; then
              ARGS="$ARGS --labels $LABELS"
            fi

            node scripts/orchestrator.js $ARGS
          fi

      - name: GitHub Pages용 파일 준비
        if: success() && steps.check-secrets.outputs.skip != 'true'
        run: |
          # docs 폴더에 통합 HTML 복사
          mkdir -p docs

          # 기존 HTML 파일 삭제
          rm -f docs/*.html

          # 통합 HTML 복사 (파일명을 index.html로)
          COMBINED_HTML=$(find output/final -name "*통합*메일정리.html" 2>/dev/null | head -1)
          if [ -n "$COMBINED_HTML" ]; then
            cp "$COMBINED_HTML" docs/index.html
          fi

      - name: GitHub Pages 배포
        if: success() && steps.check-secrets.outputs.skip != 'true'
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs
          publish_branch: gh-pages

      - name: 결과물 업로드 (MD 파일)
        if: success() && steps.check-secrets.outputs.skip != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: mail-digest-md-${{ github.run_number }}
          path: output/final/**/*.md
          retention-days: 30

      - name: Telegram 알림
        if: success() && steps.check-secrets.outputs.skip != 'true'
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          # TELEGRAM_TOKEN이 없으면 건너뛰기
          if [ -z "$TELEGRAM_TOKEN" ]; then
            echo "TELEGRAM_TOKEN이 설정되지 않아 알림을 건너뜁니다."
            exit 0
          fi

          # 라벨별 MD 파일 수 (라벨 개수)
          MD_COUNT=$(find output/final -name "*_메일정리.md" 2>/dev/null | grep -v "통합" | wc -l)

          # 라벨 목록 추출
          LABELS=$(find output/final -name "*_메일정리.md" 2>/dev/null | grep -v "통합" | xargs -I {} basename {} | sed 's/^[0-9]*_//' | sed 's/_메일정리.md$//' | tr '\n' ', ' | sed 's/,$//')

          # GitHub Pages URL (통합 HTML)
          REPO_NAME=$(echo "${{ github.repository }}" | cut -d'/' -f2)
          OWNER=$(echo "${{ github.repository }}" | cut -d'/' -f1)
          PAGES_URL="https://${OWNER}.github.io/${REPO_NAME}/"

          # Artifacts URL (MD 파일)
          ARTIFACTS_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          # 날짜
          TODAY=$(TZ='Asia/Seoul' date '+%Y-%m-%d')

          MESSAGE=$(printf "[완료] Gmail 메일 정리\n%s\n\n라벨: %s\n(%s개 라벨)\n\n[바로 보기] 통합 HTML\n%s\n\n[다운로드] MD 파일 (라벨별)\n%s" "$TODAY" "$LABELS" "$MD_COUNT" "$PAGES_URL" "$ARTIFACTS_URL")

          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d text="$MESSAGE"

      - name: 에러 알림
        if: failure()
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          # TELEGRAM_TOKEN이 없으면 건너뛰기
          if [ -z "$TELEGRAM_TOKEN" ]; then
            echo "TELEGRAM_TOKEN이 설정되지 않아 에러 알림을 건너뜁니다."
            exit 0
          fi

          MESSAGE=$(printf "[실패] Gmail 메일 정리 실패\n\n로그 확인: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}")

          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d text="$MESSAGE"
